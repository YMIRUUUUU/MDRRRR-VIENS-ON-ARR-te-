<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Vehicle Dynamics Simulator+</title>
    <style>
        :root {
            --bg: #050505;
            --panel: rgba(20, 20, 20, 0.95);
            --accent: #00f2ff;
            --warn: #ffae00;
            --danger: #ff0040;
            --ok: #00e676;
            --text: #cfcfcf;
        }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Consolas', monospace; color: var(--text); }
        canvas { display: block; }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box;
            gap: 10px;
        }

        .hud-panel {
            background: var(--panel); border: 1px solid #333; padding: 10px; border-radius: 4px;
            box-shadow: 0 0 15px rgba(0,0,0,0.8); pointer-events: auto;
        }

        #telemetry-bar { display: flex; gap: 18px; align-self: center; flex-wrap: wrap; justify-content: center; }
        .stat-box { text-align: center; min-width: 90px; }
        .stat-label { font-size: 0.7em; color: #666; text-transform: uppercase; letter-spacing: 0.04em; }
        .stat-val { font-size: 1.2em; font-weight: bold; color: white; }

        #side-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }

        .panel-group {
            display: grid;
            gap: 12px;
        }

        .panel-title {
            font-size: 0.9em;
            color: var(--accent);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 6px 16px;
            font-size: 0.85em;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .data-item span:last-child {
            color: white;
            font-weight: 600;
        }

        #dashboard { align-self: center; display: flex; gap: 30px; align-items: flex-end; }

        .tacho-container { position: relative; width: 220px; height: 220px; }
        .gear-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 4em; font-weight: 900; color: white; text-shadow: 0 0 10px var(--accent);
        }

        #g-meter { width: 110px; height: 110px; border: 1px solid #444; position: relative; background: #111; border-radius: 50%; }
        #g-dot {
            width: 8px; height: 8px; background: var(--danger); border-radius: 50%; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 5px var(--danger);
        }

        #graphs { position: absolute; top: 20px; right: 20px; width: 260px; }
        canvas.graph { width: 100%; height: 60px; background: #111; border: 1px solid #333; margin-bottom: 5px; }

        .key-hint { position: absolute; bottom: 20px; left: 20px; font-size: 0.8em; opacity: 0.7; }
        kbd { background: #333; padding: 2px 6px; border-radius: 3px; border-bottom: 2px solid #111; }

        .assist-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 6px;
            border-radius: 12px;
            background: rgba(255,255,255,0.06);
            font-size: 0.75em;
            text-transform: uppercase;
        }
        .assist-pill.active { color: var(--ok); border: 1px solid rgba(0,230,118,0.6); }
        .assist-pill.inactive { color: #666; border: 1px solid rgba(255,255,255,0.1); }

        .status-bar {
            height: 6px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        .status-bar span {
            display: block;
            height: 100%;
            background: var(--accent);
            width: 50%;
        }
    </style>
</head>
<body>

    <canvas id="simCanvas"></canvas>

    <div id="ui-layer">
        <div id="telemetry-bar" class="hud-panel">
            <div class="stat-box">
                <div class="stat-label">Vitesse</div>
                <div class="stat-val"><span id="speed">0</span> <small>km/h</small></div>
            </div>
            <div class="stat-box">
                <div class="stat-label">RPM</div>
                <div class="stat-val" id="rpm" style="color: var(--accent)">800</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Gear</div>
                <div class="stat-val" id="gear-top">N</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Boost</div>
                <div class="stat-val"><span id="boost">0.0</span> bar</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Fuel</div>
                <div class="stat-val"><span id="fuel">100</span>%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Temp Eau</div>
                <div class="stat-val"><span id="water-temp">80</span>°C</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Temp Huile</div>
                <div class="stat-val"><span id="oil-temp">90</span>°C</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Temps</div>
                <div class="stat-val"><span id="time-of-day">00:00</span></div>
            </div>
        </div>

        <div id="graphs">
            <div class="stat-label">Couple Moteur (Nm)</div>
            <canvas id="torqueGraph" class="graph" width="260" height="60"></canvas>
            <div class="stat-label">Adhérence Latérale</div>
            <canvas id="gripGraph" class="graph" width="260" height="60"></canvas>
            <div class="stat-label">Charge Freinage</div>
            <canvas id="brakeGraph" class="graph" width="260" height="60"></canvas>
        </div>

        <div id="side-panels">
            <div class="panel-group">
                <div class="hud-panel">
                    <div class="panel-title">Powertrain</div>
                    <div class="data-grid">
                        <div class="data-item"><span>Throttle</span><span id="throttle">0%</span></div>
                        <div class="data-item"><span>Couple</span><span id="torque">0 Nm</span></div>
                        <div class="data-item"><span>Charge</span><span id="engine-load">0%</span></div>
                        <div class="data-item"><span>Consommation</span><span id="fuel-flow">0 L/h</span></div>
                        <div class="data-item"><span>Downforce</span><span id="downforce">0 N</span></div>
                        <div class="data-item"><span>Traînée</span><span id="drag">0 N</span></div>
                    </div>
                    <div class="status-bar"><span id="boost-bar"></span></div>
                </div>

                <div class="hud-panel">
                    <div class="panel-title">Électrique</div>
                    <div class="data-grid">
                        <div class="data-item"><span>Tension</span><span id="battery-voltage">12.6 V</span></div>
                        <div class="data-item"><span>Charge</span><span id="battery-charge">98%</span></div>
                        <div class="data-item"><span>Alternateur</span><span id="alternator-load">0%</span></div>
                        <div class="data-item"><span>Pompes</span><span id="pump-load">OK</span></div>
                    </div>
                </div>

                <div class="hud-panel">
                    <div class="panel-title">Refroidissement</div>
                    <div class="data-grid">
                        <div class="data-item"><span>Radiateur</span><span id="radiator">0%</span></div>
                        <div class="data-item"><span>Ventilo</span><span id="fan">OFF</span></div>
                        <div class="data-item"><span>Pression Huile</span><span id="oil-pressure">0 bar</span></div>
                        <div class="data-item"><span>Thermostat</span><span id="thermostat">Fermé</span></div>
                    </div>
                </div>
            </div>

            <div class="panel-group">
                <div class="hud-panel">
                    <div class="panel-title">Châssis & Freins</div>
                    <div class="data-grid">
                        <div class="data-item"><span>Frein AV</span><span id="brake-front">0°C</span></div>
                        <div class="data-item"><span>Frein AR</span><span id="brake-rear">0°C</span></div>
                        <div class="data-item"><span>ABS</span><span id="abs-status">ON</span></div>
                        <div class="data-item"><span>TCS</span><span id="tcs-status">ON</span></div>
                        <div class="data-item"><span>ESC</span><span id="esc-status">ON</span></div>
                        <div class="data-item"><span>Direction</span><span id="steer-angle">0°</span></div>
                    </div>
                    <div>
                        <span class="assist-pill" id="abs-pill">ABS</span>
                        <span class="assist-pill" id="tcs-pill">TCS</span>
                        <span class="assist-pill" id="esc-pill">ESC</span>
                    </div>
                </div>

                <div class="hud-panel">
                    <div class="panel-title">Pneus</div>
                    <div class="data-grid">
                        <div class="data-item"><span>Temp AV</span><span id="tire-temp-front">0°C</span></div>
                        <div class="data-item"><span>Temp AR</span><span id="tire-temp-rear">0°C</span></div>
                        <div class="data-item"><span>Pression AV</span><span id="tire-psi-front">0 psi</span></div>
                        <div class="data-item"><span>Pression AR</span><span id="tire-psi-rear">0 psi</span></div>
                        <div class="data-item"><span>Usure</span><span id="tire-wear">0%</span></div>
                        <div class="data-item"><span>Grip</span><span id="tire-grip">0%</span></div>
                    </div>
                </div>

                <div class="hud-panel">
                    <div class="panel-title">Environnement</div>
                    <div class="data-grid">
                        <div class="data-item"><span>Temp Air</span><span id="ambient-temp">0°C</span></div>
                        <div class="data-item"><span>Temp Piste</span><span id="track-temp">0°C</span></div>
                        <div class="data-item"><span>Pluie</span><span id="rain">0%</span></div>
                        <div class="data-item"><span>Vent</span><span id="wind">0 km/h</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="key-hint hud-panel">
            <p><kbd>↑</kbd> Accélérer | <kbd>↓</kbd> Frein/Recul</p>
            <p><kbd>←</kbd> <kbd>→</kbd> Direction</p>
            <p><kbd>ESPACE</kbd> Frein à main</p>
            <p><kbd>D</kbd> Debug | <kbd>R</kbd> Pluie | <kbd>T</kbd> TCS | <kbd>A</kbd> ABS | <kbd>E</kbd> ESC</p>
        </div>

        <div id="dashboard">
            <div class="hud-panel">
                <div style="text-align:center; margin-bottom:5px; color:#666; font-size:0.8em;">G-FORCE</div>
                <div id="g-meter"><div id="g-dot"></div></div>
            </div>

            <div class="tacho-container">
                <canvas id="tachoCanvas" width="220" height="220"></canvas>
                <div class="gear-indicator" id="gear">N</div>
            </div>
        </div>
    </div>

<script>
/**
 * ULTIMATE CAR PHYSICS ENGINE PLUS
 * Modules: moteur, transmission, freinage, pneus, environnement, électronique, assists
 */

const Vec2 = {
    new: (x=0, y=0) => ({x, y}),
    add: (v1, v2) => ({x: v1.x + v2.x, y: v1.y + v2.y}),
    sub: (v1, v2) => ({x: v1.x - v2.x, y: v1.y - v2.y}),
    mul: (v, s) => ({x: v.x * s, y: v.y * s}),
    mag: (v) => Math.sqrt(v.x*v.x + v.y*v.y),
    norm: (v) => { const m = Math.sqrt(v.x*v.x + v.y*v.y); return m===0 ? {x:0,y:0} : {x:v.x/m, y:v.y/m}; },
    dot: (v1, v2) => v1.x*v2.x + v1.y*v2.y,
    cross: (v1, v2) => v1.x*v2.y - v1.y*v2.x,
    rotate: (v, angle) => {
        const c = Math.cos(angle), s = Math.sin(angle);
        return {x: v.x*c - v.y*s, y: v.x*s + v.y*c};
    },
    project: (v, u) => {
        const d = v.x*u.x + v.y*u.y;
        return {x: u.x*d, y: u.y*d};
    }
};

const clamp = (val, min, max) => Math.max(min, Math.min(max, val));
const lerp = (a, b, t) => a + (b - a) * t;
const smoothstep = (t) => t * t * (3 - 2 * t);

const CAR = {
    mass: 1420,
    inertia: 2600,
    wheelBase: 2.68,
    trackWidth: 1.62,
    cgToFront: 1.32,
    cgToRear: 1.36,
    cgHeight: 0.52,

    torqueCurve: [
        {rpm: 0, tq: 180}, {rpm: 900, tq: 240}, {rpm: 1800, tq: 320},
        {rpm: 3000, tq: 430}, {rpm: 4500, tq: 520}, {rpm: 6000, tq: 560},
        {rpm: 7200, tq: 430}, {rpm: 8000, tq: 0}
    ],
    redline: 7200,
    idle: 850,
    gears: [3.6, 2.2, 1.6, 1.2, 0.98, 0.78, 0.64],
    reverseRatio: 3.3,
    finalDrive: 3.7,

    brakeTorqueMax: 4200,
    handbrakeTorque: 8200,

    tireGrip: 1.24,
    corneringStiffness: 130000,
    dragCoeff: 0.34,
    liftCoeff: -0.6,
    frontalArea: 2.25,
    rollingRes: 0.014,

    fuelCapacity: 55,
    batteryCapacityAh: 70
};

class Tire {
    constructor(isFront) {
        this.isFront = isFront;
        this.slipAngle = 0;
        this.slipRatio = 0;
        this.force = Vec2.new();
        this.load = 0;
        this.angularVel = 0;
        this.radius = 0.32;
        this.smoke = 0;
        this.temp = 25;
        this.pressure = 31;
        this.wear = 0;
        this.gripFactor = 1;
    }

    update(dt, slipEnergy, ambient, trackTemp) {
        const tempTarget = trackTemp + slipEnergy * 140;
        this.temp += (tempTarget - this.temp) * 0.08 * dt * 60;
        this.pressure = 28 + (this.temp - 20) * 0.08;
        this.wear = clamp(this.wear + slipEnergy * 0.004 * dt * 60, 0, 1);

        const tempDelta = Math.abs(this.temp - 90);
        const tempPenalty = clamp(tempDelta / 90, 0, 0.4);
        const wearPenalty = this.wear * 0.45;
        this.gripFactor = clamp(1 - tempPenalty - wearPenalty, 0.4, 1.1);
    }

    calculateLateralForce(slipAngle, load, gripScale) {
        const peakSlip = 0.12;
        const stiff = CAR.corneringStiffness * gripScale;
        const maxForce = load * CAR.tireGrip * gripScale;
        let latForce = -slipAngle * stiff;
        if (Math.abs(latForce) > maxForce) {
            latForce = Math.sign(latForce) * maxForce;
            const excess = Math.abs(slipAngle) - peakSlip;
            if (excess > 0) latForce *= Math.max(0.7, 1.0 - excess * 2);
        }
        return latForce;
    }
}

class EngineSystem {
    constructor() {
        this.rpm = CAR.idle;
        this.temp = 80;
        this.oilTemp = 90;
        this.boost = 0;
        this.load = 0;
        this.fuelFlow = 0;
    }

    getTorque(rpm) {
        const curve = CAR.torqueCurve;
        if (rpm <= curve[0].rpm) return curve[0].tq;
        if (rpm >= curve[curve.length-1].rpm) return 0;
        for (let i=0; i<curve.length-1; i++) {
            if (rpm >= curve[i].rpm && rpm < curve[i+1].rpm) {
                const t = (rpm - curve[i].rpm) / (curve[i+1].rpm - curve[i].rpm);
                return lerp(curve[i].tq, curve[i+1].tq, t);
            }
        }
        return 0;
    }

    update(dt, throttle, targetRpm, ambientTemp, coolingPower) {
        this.rpm += (targetRpm - this.rpm) * 0.12;
        this.load = clamp(throttle * (this.rpm / CAR.redline), 0, 1);
        this.boost = clamp((this.rpm - 2500) / 3000, 0, 1) * throttle * 1.2;
        const heatGain = (0.2 + this.load * 0.8) * (1 + this.boost * 0.3);
        const cooling = coolingPower * (this.temp - ambientTemp) * 0.02;
        this.temp += (heatGain - cooling) * dt * 25;
        this.oilTemp += (heatGain * 0.8 - cooling * 0.7) * dt * 20;
        this.fuelFlow = 4 + this.load * 35 + this.boost * 12;
    }
}

class TransmissionSystem {
    constructor() {
        this.gear = 0;
        this.clutch = 0;
        this.shiftTimer = 0;
        this.differentialLock = 0.3;
    }

    update(dt, input, rpm) {
        if (this.shiftTimer > 0) this.shiftTimer -= dt;
        if (this.gear === 0 && input.throttle) this.gear = 1;
        if (this.gear === 0 && input.brake && input.speed < 1) this.gear = -1;

        if (this.gear > 0 && rpm > 6800 && this.gear < CAR.gears.length) {
            this.gear++;
            this.shiftTimer = 0.2;
        }
        if (this.gear > 1 && rpm < 2400) {
            this.gear--;
            this.shiftTimer = 0.2;
        }
    }

    getRatio() {
        if (this.gear > 0) return CAR.gears[this.gear-1] * CAR.finalDrive;
        if (this.gear === -1) return -CAR.reverseRatio * CAR.finalDrive;
        return 0;
    }
}

class BrakeSystem {
    constructor() {
        this.tempFront = 60;
        this.tempRear = 50;
        this.absActive = true;
        this.fade = 0;
    }

    update(dt, brakeInput, speed) {
        const heat = brakeInput * Math.max(speed, 5) * 0.15;
        this.tempFront += (heat - 3) * dt * 20;
        this.tempRear += (heat * 0.8 - 3) * dt * 20;
        const avgTemp = (this.tempFront + this.tempRear) / 2;
        this.fade = clamp((avgTemp - 350) / 250, 0, 0.6);
    }

    getBrakeForce(input, wheelRadius) {
        const torque = input * CAR.brakeTorqueMax * (1 - this.fade);
        return torque / wheelRadius;
    }
}

class ElectricalSystem {
    constructor() {
        this.charge = 0.98;
        this.voltage = 12.6;
        this.alternatorLoad = 0;
        this.pumpLoad = 0.2;
    }

    update(dt, rpm, coolingDemand) {
        this.alternatorLoad = clamp(coolingDemand * 0.8 + (rpm / 7000) * 0.3, 0, 1);
        const chargeDelta = (this.alternatorLoad * 0.02 - 0.005 - this.pumpLoad * 0.01) * dt;
        this.charge = clamp(this.charge + chargeDelta, 0.7, 1);
        this.voltage = 12 + this.charge * 1.2;
    }
}

class EnvironmentSystem {
    constructor() {
        this.time = 0;
        this.rain = 0;
        this.ambientTemp = 18;
        this.trackTemp = 22;
        this.wind = 5;
    }

    toggleRain() {
        this.rain = this.rain > 0.1 ? 0 : 0.6;
    }

    update(dt, speed) {
        this.time += dt * 0.02;
        if (this.time > 24) this.time -= 24;
        const sun = Math.max(0, Math.sin((this.time / 24) * Math.PI * 2));
        this.ambientTemp = 12 + sun * 14;
        this.trackTemp += (this.ambientTemp + sun * 20 - this.trackTemp) * 0.02 * dt * 60;
        this.wind = 5 + Math.sin(this.time) * 3 + speed * 0.02;
    }

    getTimeString() {
        const hours = Math.floor(this.time);
        const minutes = Math.floor((this.time - hours) * 60);
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }
}

class DriverAssistSystem {
    constructor() {
        this.abs = true;
        this.tcs = true;
        this.esc = true;
        this.absActivity = 0;
        this.tcsActivity = 0;
        this.escActivity = 0;
    }

    update(dt, slipRatio, slipAngle, brakeInput) {
        this.absActivity = this.abs && brakeInput > 0.2 && Math.abs(slipRatio) > 0.15 ? 1 : 0;
        this.tcsActivity = this.tcs && slipRatio > 0.12 ? 1 : 0;
        this.escActivity = this.esc && Math.abs(slipAngle) > 0.2 ? 1 : 0;
        this.absActivity = lerp(this.absActivity, 0, dt * 3);
        this.tcsActivity = lerp(this.tcsActivity, 0, dt * 2);
        this.escActivity = lerp(this.escActivity, 0, dt * 1.5);
    }
}

class CarSimulation {
    constructor() {
        this.pos = Vec2.new(0, 0);
        this.vel = Vec2.new(0, 0);
        this.heading = 0;
        this.yawRate = 0;
        this.steerAngle = 0;
        this.lastVelY = 0;
        this.gForce = Vec2.new();
        this.debug = false;
        this.skidMarks = [];

        this.engine = new EngineSystem();
        this.transmission = new TransmissionSystem();
        this.brakes = new BrakeSystem();
        this.electrical = new ElectricalSystem();
        this.environment = new EnvironmentSystem();
        this.assist = new DriverAssistSystem();

        this.fuel = CAR.fuelCapacity;
        this.tires = [
            new Tire(true), new Tire(true),
            new Tire(false), new Tire(false)
        ];

        this.downforce = 0;
        this.dragForce = 0;
    }

    update(dt, input) {
        const targetSteer = (input.right - input.left) * 0.6;
        const steerSpeed = 5.0 * dt;
        this.steerAngle += clamp(targetSteer - this.steerAngle, -steerSpeed, steerSpeed);

        const cosH = Math.cos(this.heading);
        const sinH = Math.sin(this.heading);
        const forward = {x: sinH, y: -cosH};
        const right = {x: cosH, y: sinH};

        const velLocal = {
            x: this.vel.x * right.x + this.vel.y * right.y,
            y: this.vel.x * forward.x + this.vel.y * forward.y
        };

        const speed = Vec2.mag(this.vel);
        this.environment.update(dt, speed * 3.6);

        const accelLong = (velLocal.y - this.lastVelY) / dt / 9.81 || 0;
        this.lastVelY = velLocal.y;

        const accelLat = (velLocal.x - (this.lastVelX || 0)) / dt / 9.81 || 0;
        this.lastVelX = velLocal.x;

        const staticWeight = CAR.mass * 9.81;
        const weightFront = staticWeight * (CAR.cgToRear / CAR.wheelBase);
        const weightRear = staticWeight * (CAR.cgToFront / CAR.wheelBase);

        const weightTransferLong = (accelLong * CAR.cgHeight / CAR.wheelBase) * staticWeight;
        const weightTransferLat = (accelLat * CAR.cgHeight / CAR.trackWidth) * staticWeight * 0.6;

        const aeroDownforce = 0.5 * 1.225 * CAR.frontalArea * Math.pow(velLocal.y, 2) * -CAR.liftCoeff;
        this.downforce = aeroDownforce;

        const loadF = (weightFront + weightTransferLong + aeroDownforce * 0.55) / 2;
        const loadR = (weightRear - weightTransferLong + aeroDownforce * 0.45) / 2;

        this.tires[0].load = loadF - weightTransferLat / 2;
        this.tires[1].load = loadF + weightTransferLat / 2;
        this.tires[2].load = loadR - weightTransferLat / 2;
        this.tires[3].load = loadR + weightTransferLat / 2;

        let totalForce = Vec2.new();
        let totalMoment = 0;

        const wheelRadius = 0.32;
        const wheelRpm = (Math.abs(velLocal.y) * 60) / (2 * Math.PI * wheelRadius);

        this.transmission.update(dt, { ...input, speed }, this.engine.rpm);
        const driveRatio = this.transmission.getRatio();
        const targetRpm = Math.abs(wheelRpm * driveRatio) || CAR.idle;

        const coolingDemand = clamp((this.engine.temp - 90) / 40, 0, 1);
        this.engine.update(dt, input.throttle, targetRpm, this.environment.ambientTemp, coolingDemand);
        this.electrical.update(dt, this.engine.rpm, coolingDemand);

        const engineTorque = this.engine.getTorque(this.engine.rpm);
        const boostTorque = engineTorque * (1 + this.engine.boost * 0.25);
        const driveTorque = boostTorque * driveRatio * input.throttle;

        this.brakes.update(dt, input.brake, speed);

        const brakeForce = this.brakes.getBrakeForce(input.brake, wheelRadius);
        let longForceVal = driveTorque / wheelRadius;
        if (velLocal.y > 0) longForceVal -= brakeForce;
        else if (velLocal.y < 0) longForceVal += brakeForce;

        const dragForce = 0.5 * CAR.dragCoeff * CAR.frontalArea * 1.225 * velLocal.y * velLocal.y * Math.sign(-velLocal.y);
        const rollForce = -velLocal.y * CAR.rollingRes * CAR.mass * 9.81;
        this.dragForce = dragForce;

        longForceVal += dragForce + rollForce;

        const longForceVec = Vec2.mul(forward, longForceVal);
        totalForce = Vec2.add(totalForce, longForceVec);

        this.tires.forEach((tire, i) => {
            const isFront = tire.isFront;
            const wheelOffsetLong = isFront ? CAR.cgToFront : -CAR.cgToRear;
            const tireVelLat = velLocal.x + this.yawRate * wheelOffsetLong;
            const tireVelLong = velLocal.y;
            const wheelSteer = isFront ? this.steerAngle : 0;
            const absLong = Math.max(1.0, Math.abs(tireVelLong));
            tire.slipAngle = Math.atan2(tireVelLat, absLong) - wheelSteer;
            tire.slipRatio = clamp((driveTorque / (tire.load * wheelRadius + 1)) - (tireVelLong / (wheelRadius * 20)), -1, 1);

            const rainFactor = 1 - this.environment.rain * 0.5;
            const gripScale = tire.gripFactor * rainFactor;
            const latForceMag = tire.calculateLateralForce(tire.slipAngle, tire.load, gripScale);

            const wheelHeading = this.heading + wheelSteer;
            const wheelRight = {x: Math.cos(wheelHeading), y: Math.sin(wheelHeading)};
            const tireForceWorld = Vec2.mul(wheelRight, latForceMag);

            totalForce = Vec2.add(totalForce, tireForceWorld);
            totalMoment += latForceMag * wheelOffsetLong;

            const slipEnergy = Math.abs(tire.slipAngle) + Math.abs(tire.slipRatio) * 0.6;
            tire.update(dt, slipEnergy, this.environment.ambientTemp, this.environment.trackTemp);

            tire.force = tireForceWorld;
            tire.smoke = Math.abs(tire.slipAngle) > 0.22 && Math.abs(velLocal.y) > 2 ? Math.min(1, (Math.abs(tire.slipAngle)-0.2)*5) : 0;
        });

        const avgSlipRatio = this.tires.reduce((sum, t) => sum + t.slipRatio, 0) / this.tires.length;
        const avgSlipAngle = this.tires.reduce((sum, t) => sum + t.slipAngle, 0) / this.tires.length;
        this.assist.update(dt, avgSlipRatio, avgSlipAngle, input.brake);

        let driveAssistFactor = 1;
        if (this.assist.tcs && this.assist.tcsActivity > 0.1) driveAssistFactor -= 0.3 * this.assist.tcsActivity;
        if (this.assist.abs && this.assist.absActivity > 0.1) longForceVal *= 0.85;

        totalForce = Vec2.add(totalForce, Vec2.mul(forward, longForceVal * driveAssistFactor * 0.02));
        totalMoment *= this.assist.esc ? (1 - this.assist.escActivity * 0.3) : 1;

        const acc = Vec2.mul(totalForce, 1/CAR.mass);
        const alpha = totalMoment / CAR.inertia;

        this.vel = Vec2.add(this.vel, Vec2.mul(acc, dt));
        this.yawRate += alpha * dt;
        this.yawRate *= 0.98;

        this.pos = Vec2.add(this.pos, Vec2.mul(this.vel, dt));
        this.heading += this.yawRate * dt;

        const gx = (acc.x * right.x + acc.y * right.y) / 9.81;
        const gy = (acc.x * forward.x + acc.y * forward.y) / 9.81;
        this.gForce.x += (gx - this.gForce.x) * 0.1;
        this.gForce.y += (gy - this.gForce.y) * 0.1;

        if (Math.abs(this.tires[2].slipAngle) > 0.3 || input.handbrake) {
            this.addSkidMark(this.pos, this.heading, 1.0);
        } else {
            this.finishSkidMark();
        }

        const fuelUse = (this.engine.fuelFlow / 3600) * dt;
        this.fuel = clamp(this.fuel - fuelUse, 0, CAR.fuelCapacity);
    }

    addSkidMark(pos, heading) {
        const rearX = pos.x - Math.sin(heading) * CAR.cgToRear;
        const rearY = pos.y + Math.cos(heading) * CAR.cgToRear;
        const w = CAR.trackWidth / 2;
        const lX = rearX - Math.cos(heading) * w;
        const lY = rearY - Math.sin(heading) * w;
        const rX = rearX + Math.cos(heading) * w;
        const rY = rearY + Math.sin(heading) * w;

        if (this.skidMarks.length === 0 || !this.skidMarks[this.skidMarks.length-1].active) {
            this.skidMarks.push({active: true, ptsL: [], ptsR: [], life: 10.0});
        }
        const current = this.skidMarks[this.skidMarks.length-1];
        current.ptsL.push({x: lX, y: lY});
        current.ptsR.push({x: rX, y: rY});
    }

    finishSkidMark() {
        if (this.skidMarks.length > 0) this.skidMarks[this.skidMarks.length-1].active = false;
    }
}

class Game {
    constructor() {
        this.canvas = document.getElementById('simCanvas');
        this.ctx = this.canvas.getContext('2d', {alpha: false});

        this.bgCanvas = document.createElement('canvas');
        this.bgCtx = this.bgCanvas.getContext('2d');

        this.sim = new CarSimulation();
        this.input = { throttle: 0, brake: 0, left: 0, right: 0, handbrake: 0 };

        this.camera = { x: 0, y: 0, zoom: 15 };
        this.lastTime = 0;

        this.initEvents();
        this.resize();
        requestAnimationFrame(t => this.loop(t));
    }

    initEvents() {
        window.addEventListener('resize', () => this.resize());
        const keys = {};
        const updateInput = () => {
            this.input.throttle = keys['ArrowUp'] ? 1 : 0;
            this.input.brake = keys['ArrowDown'] ? 1 : 0;
            this.input.left = keys['ArrowLeft'] ? 1 : 0;
            this.input.right = keys['ArrowRight'] ? 1 : 0;
            this.input.handbrake = keys[' '] ? 1 : 0;
        };
        window.addEventListener('keydown', e => {
            keys[e.key] = true;
            if (e.key === 'd') this.sim.debug = !this.sim.debug;
            if (e.key === 'r') this.sim.environment.toggleRain();
            if (e.key === 't') this.sim.assist.tcs = !this.sim.assist.tcs;
            if (e.key === 'a') this.sim.assist.abs = !this.sim.assist.abs;
            if (e.key === 'e') this.sim.assist.esc = !this.sim.assist.esc;
            updateInput();
        });
        window.addEventListener('keyup', e => { keys[e.key] = false; updateInput(); });
    }

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.bgCanvas.width = window.innerWidth;
        this.bgCanvas.height = window.innerHeight;
        this.drawStaticWorld();
    }

    drawStaticWorld() {
        const ctx = this.bgCtx;
        ctx.fillStyle = '#0a0a0a';
        ctx.fillRect(0,0, ctx.canvas.width, ctx.canvas.height);

        ctx.strokeStyle = '#222';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i=0; i<ctx.canvas.width; i+=100) { ctx.moveTo(i,0); ctx.lineTo(i, ctx.canvas.height); }
        for (let i=0; i<ctx.canvas.height; i+=100) { ctx.moveTo(0,i); ctx.lineTo(ctx.canvas.width, i); }
        ctx.stroke();

        ctx.fillStyle = '#e65100';
        for (let i=0; i<15; i++) {
            const x = Math.random() * ctx.canvas.width;
            const y = Math.random() * ctx.canvas.height;
            ctx.beginPath(); ctx.arc(x, y, 5, 0, Math.PI*2); ctx.fill();
        }
    }

    loop(timestamp) {
        const dt = Math.min((timestamp - this.lastTime) / 1000, 0.1);
        this.lastTime = timestamp;

        const steps = 4;
        for (let i=0; i<steps; i++) this.sim.update(dt/steps, this.input);

        this.render();
        this.updateUI();
        requestAnimationFrame(t => this.loop(t));
    }

    render() {
        const ctx = this.ctx;
        const car = this.sim;

        this.camera.x += (car.pos.x - this.camera.x) * 0.1;
        this.camera.y += (car.pos.y - this.camera.y) * 0.1;

        ctx.setTransform(1,0,0,1,0,0);
        ctx.fillStyle = '#111';
        ctx.fillRect(0,0, this.canvas.width, this.canvas.height);

        const cx = this.canvas.width / 2;
        const cy = this.canvas.height / 2;
        const zoom = this.camera.zoom * (1 - Math.min(0.3, Vec2.mag(car.vel)/100));

        ctx.translate(cx, cy);
        ctx.scale(zoom, zoom);
        ctx.translate(-this.camera.x, -this.camera.y);

        this.drawGrid(ctx);

        ctx.strokeStyle = '#111';
        ctx.lineWidth = 0.3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        car.skidMarks.forEach(skid => {
            if (skid.ptsL.length < 2) return;
            ctx.beginPath();
            skid.ptsL.forEach((p, i) => i===0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
            ctx.stroke();
            ctx.beginPath();
            skid.ptsR.forEach((p, i) => i===0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
            ctx.stroke();
        });

        ctx.save();
        ctx.translate(car.pos.x, car.pos.y);
        ctx.rotate(car.heading);

        ctx.fillStyle = 'rgba(0,0,0,0.6)';
        ctx.filter = 'blur(10px)';
        ctx.fillRect(-1.1, -2.4, 2.2, 4.8);
        ctx.filter = 'none';

        ctx.fillStyle = '#222';
        ctx.beginPath(); ctx.roundRect(-0.9, -2.1, 1.8, 4.2, 0.2); ctx.fill();

        const speedShake = Math.random() * (Vec2.mag(car.vel) > 20 ? 0.02 : 0);
        ctx.translate(speedShake, 0);

        ctx.fillStyle = '#37474f';
        ctx.beginPath();
        ctx.moveTo(-0.9, -2.0); ctx.lineTo(0.9, -2.0);
        ctx.lineTo(0.85, 1.2); ctx.lineTo(-0.85, 1.2);
        ctx.fill();

        ctx.fillStyle = '#111';
        ctx.beginPath(); ctx.roundRect(-0.7, -1.0, 1.4, 1.8, 0.3); ctx.fill();
        ctx.fillStyle = 'rgba(100,200,255,0.2)';
        ctx.fillRect(-0.65, -0.2, 1.3, 0.8);

        this.drawWheel(ctx, -0.85, 1.35, car.steerAngle, true);
        this.drawWheel(ctx, 0.85, 1.35, car.steerAngle, true);
        this.drawWheel(ctx, -0.85, -1.35, 0, false);
        this.drawWheel(ctx, 0.85, -1.35, 0, false);

        ctx.fillStyle = this.input.brake ? '#ff0000' : '#500000';
        ctx.shadowColor = '#ff0000'; ctx.shadowBlur = this.input.brake ? 20 : 0;
        ctx.fillRect(-0.8, -2.15, 0.5, 0.15);
        ctx.fillRect(0.3, -2.15, 0.5, 0.15);
        ctx.shadowBlur = 0;

        ctx.globalCompositeOperation = 'screen';
        ctx.fillStyle = 'rgba(255, 255, 200, 0.3)';
        ctx.beginPath(); ctx.moveTo(-0.7, 2.0); ctx.lineTo(-4, 15); ctx.lineTo(1, 15); ctx.fill();
        ctx.beginPath(); ctx.moveTo(0.7, 2.0); ctx.lineTo(4, 15); ctx.lineTo(-1, 15); ctx.fill();
        ctx.globalCompositeOperation = 'source-over';

        if (car.engine.rpm > 6500 && Math.random() > 0.7) {
            ctx.fillStyle = '#ffaa00';
            ctx.beginPath(); ctx.arc(0.4, -2.3, 0.1 + Math.random()*0.2, 0, Math.PI*2); ctx.fill();
        }

        if (car.debug) {
            ctx.strokeStyle = '#0f0'; ctx.lineWidth = 0.05;
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, Vec2.mag(car.vel)*0.1); ctx.stroke();
            ctx.fillStyle = 'yellow'; ctx.beginPath(); ctx.arc(0,0, 0.1, 0, Math.PI*2); ctx.fill();
        }

        ctx.restore();

        car.tires.forEach((tire, i) => {
            if (tire.smoke > 0) {
                const isFront = tire.isFront;
                const offsetL = isFront ? CAR.cgToFront : -CAR.cgToRear;
                const offsetW = (i%2===0 ? -1 : 1) * CAR.trackWidth/2;

                const wx = car.pos.x + Math.sin(car.heading)*offsetL + Math.cos(car.heading)*offsetW;
                const wy = car.pos.y - Math.cos(car.heading)*offsetL + Math.sin(car.heading)*offsetW;

                this.drawSmoke(ctx, wx, wy, tire.smoke);
            }
        });

        if (car.environment.rain > 0.1) {
            ctx.fillStyle = 'rgba(120, 150, 180, 0.1)';
            for (let i=0; i<150; i++) {
                ctx.fillRect(this.camera.x + (Math.random()-0.5)*60, this.camera.y + (Math.random()-0.5)*40, 0.05, 0.3);
            }
        }
    }

    drawWheel(ctx, x, y, angle, front) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);
        ctx.fillStyle = '#111';
        ctx.fillRect(-0.15, -0.35, 0.3, 0.7);

        ctx.fillStyle = '#444';
        if (Math.abs(this.sim.vel.x) > 1 || Math.abs(this.sim.vel.y) > 1) {
             ctx.fillStyle = '#333';
        }
        ctx.fillRect(-0.1, -0.2, 0.2, 0.4);

        if (front) {
            ctx.fillStyle = '#c00';
            ctx.fillRect(-0.12, -0.15, 0.05, 0.3);
        }

        ctx.restore();
    }

    drawSmoke(ctx, x, y, amount) {
        ctx.fillStyle = `rgba(200, 200, 200, ${amount * 0.4})`;
        for (let i=0; i<3; i++) {
            const size = 0.5 + Math.random();
            ctx.beginPath();
            ctx.arc(x + (Math.random()-0.5), y + (Math.random()-0.5), size, 0, Math.PI*2);
            ctx.fill();
        }
    }

    drawGrid(ctx) {
        const gSize = 10;
        const range = 50;

        const startX = Math.floor((this.camera.x - range)/gSize) * gSize;
        const startY = Math.floor((this.camera.y - range)/gSize) * gSize;

        ctx.strokeStyle = '#333';
        ctx.lineWidth = 0.05;
        ctx.beginPath();
        for (let x = startX; x < this.camera.x + range; x += gSize) {
            ctx.moveTo(x, this.camera.y - range); ctx.lineTo(x, this.camera.y + range);
        }
        for (let y = startY; y < this.camera.y + range; y += gSize) {
            ctx.moveTo(this.camera.x - range, y); ctx.lineTo(this.camera.x + range, y);
        }
        ctx.stroke();
    }

    updateUI() {
        const car = this.sim;
        const vel = Vec2.mag(car.vel) * 3.6;

        document.getElementById('speed').textContent = Math.floor(vel);
        document.getElementById('rpm').textContent = Math.floor(car.engine.rpm);
        document.getElementById('gear').textContent = car.transmission.gear === 0 ? 'N' : (car.transmission.gear === -1 ? 'R' : car.transmission.gear);
        document.getElementById('gear-top').textContent = car.transmission.gear === 0 ? 'N' : (car.transmission.gear === -1 ? 'R' : car.transmission.gear);

        const dot = document.getElementById('g-dot');
        const maxG = 2.0;
        const gx = clamp(car.gForce.x / maxG, -1, 1) * 45;
        const gy = clamp(car.gForce.y / maxG, -1, 1) * 45;
        dot.style.transform = `translate(calc(-50% + ${gx}px), calc(-50% + ${-gy}px))`;

        const throttlePct = Math.round(this.input.throttle * 100);
        document.getElementById('throttle').textContent = `${throttlePct}%`;
        const torque = car.engine.getTorque(car.engine.rpm);
        document.getElementById('torque').textContent = `${Math.round(torque)} Nm`;
        document.getElementById('engine-load').textContent = `${Math.round(car.engine.load * 100)}%`;
        document.getElementById('fuel-flow').textContent = `${car.engine.fuelFlow.toFixed(1)} L/h`;
        document.getElementById('boost').textContent = car.engine.boost.toFixed(1);
        document.getElementById('fuel').textContent = Math.round((car.fuel / CAR.fuelCapacity) * 100);
        document.getElementById('water-temp').textContent = Math.round(car.engine.temp);
        document.getElementById('oil-temp').textContent = Math.round(car.engine.oilTemp);
        document.getElementById('time-of-day').textContent = car.environment.getTimeString();
        document.getElementById('downforce').textContent = `${Math.round(car.downforce)} N`;
        document.getElementById('drag').textContent = `${Math.round(car.dragForce)} N`;

        const boostBar = document.getElementById('boost-bar');
        boostBar.style.width = `${car.engine.boost * 100}%`;
        boostBar.style.background = car.engine.boost > 0.9 ? 'var(--danger)' : 'var(--accent)';

        document.getElementById('battery-voltage').textContent = `${car.electrical.voltage.toFixed(1)} V`;
        document.getElementById('battery-charge').textContent = `${Math.round(car.electrical.charge * 100)}%`;
        document.getElementById('alternator-load').textContent = `${Math.round(car.electrical.alternatorLoad * 100)}%`;
        document.getElementById('pump-load').textContent = car.electrical.pumpLoad > 0.3 ? 'HIGH' : 'OK';

        document.getElementById('radiator').textContent = `${Math.round(clamp((car.engine.temp - 70) / 50, 0, 1) * 100)}%`;
        document.getElementById('fan').textContent = car.engine.temp > 98 ? 'ON' : 'OFF';
        document.getElementById('oil-pressure').textContent = `${(2.5 + car.engine.rpm / 3500).toFixed(1)} bar`;
        document.getElementById('thermostat').textContent = car.engine.temp > 85 ? 'Ouvert' : 'Fermé';

        document.getElementById('brake-front').textContent = `${Math.round(car.brakes.tempFront)}°C`;
        document.getElementById('brake-rear').textContent = `${Math.round(car.brakes.tempRear)}°C`;
        document.getElementById('abs-status').textContent = car.assist.abs ? 'ON' : 'OFF';
        document.getElementById('tcs-status').textContent = car.assist.tcs ? 'ON' : 'OFF';
        document.getElementById('esc-status').textContent = car.assist.esc ? 'ON' : 'OFF';
        document.getElementById('steer-angle').textContent = `${Math.round(this.sim.steerAngle * 57.3)}°`;

        const absPill = document.getElementById('abs-pill');
        absPill.className = `assist-pill ${car.assist.abs ? 'active' : 'inactive'}`;
        const tcsPill = document.getElementById('tcs-pill');
        tcsPill.className = `assist-pill ${car.assist.tcs ? 'active' : 'inactive'}`;
        const escPill = document.getElementById('esc-pill');
        escPill.className = `assist-pill ${car.assist.esc ? 'active' : 'inactive'}`;

        const frontTemp = (car.tires[0].temp + car.tires[1].temp) / 2;
        const rearTemp = (car.tires[2].temp + car.tires[3].temp) / 2;
        const frontPsi = (car.tires[0].pressure + car.tires[1].pressure) / 2;
        const rearPsi = (car.tires[2].pressure + car.tires[3].pressure) / 2;
        const wearAvg = (car.tires[0].wear + car.tires[1].wear + car.tires[2].wear + car.tires[3].wear) / 4;
        const gripAvg = (car.tires[0].gripFactor + car.tires[1].gripFactor + car.tires[2].gripFactor + car.tires[3].gripFactor) / 4;

        document.getElementById('tire-temp-front').textContent = `${Math.round(frontTemp)}°C`;
        document.getElementById('tire-temp-rear').textContent = `${Math.round(rearTemp)}°C`;
        document.getElementById('tire-psi-front').textContent = `${frontPsi.toFixed(1)} psi`;
        document.getElementById('tire-psi-rear').textContent = `${rearPsi.toFixed(1)} psi`;
        document.getElementById('tire-wear').textContent = `${Math.round(wearAvg * 100)}%`;
        document.getElementById('tire-grip').textContent = `${Math.round(gripAvg * 100)}%`;

        document.getElementById('ambient-temp').textContent = `${Math.round(car.environment.ambientTemp)}°C`;
        document.getElementById('track-temp').textContent = `${Math.round(car.environment.trackTemp)}°C`;
        document.getElementById('rain').textContent = `${Math.round(car.environment.rain * 100)}%`;
        document.getElementById('wind').textContent = `${Math.round(car.environment.wind)} km/h`;

        const tc = document.getElementById('tachoCanvas');
        const tctx = tc.getContext('2d');
        tctx.clearRect(0,0,220,220);
        tctx.strokeStyle = '#333'; tctx.lineWidth = 15;
        tctx.beginPath(); tctx.arc(110,110, 90, 0.7*Math.PI, 2.3*Math.PI); tctx.stroke();

        const pct = (car.engine.rpm / 8000);
        const endAngle = 0.7*Math.PI + (pct * 1.6*Math.PI);

        const grad = tctx.createLinearGradient(0,0,220,0);
        grad.addColorStop(0, '#00f2ff'); grad.addColorStop(0.8, '#00f2ff'); grad.addColorStop(1, '#ff0040');

        tctx.strokeStyle = grad;
        tctx.beginPath(); tctx.arc(110,110, 90, 0.7*Math.PI, endAngle); tctx.stroke();

        this.drawMiniGraph('torqueGraph', torque, 650, '#ffae00');
        const gripValue = Math.abs(car.tires[2].calculateLateralForce(car.tires[2].slipAngle, 3500, car.tires[2].gripFactor));
        this.drawMiniGraph('gripGraph', gripValue, 6000, '#00f2ff');
        this.drawMiniGraph('brakeGraph', car.brakes.fade * 100, 100, '#ff0040');
    }

    drawMiniGraph(id, val, max, color) {
        const c = document.getElementById(id);
        const ctx = c.getContext('2d');
        const img = ctx.getImageData(1, 0, c.width-1, c.height);
        ctx.putImageData(img, 0, 0);
        ctx.clearRect(c.width-1, 0, 1, c.height);

        const h = (val / max) * c.height;
        ctx.fillStyle = color;
        ctx.fillRect(c.width-1, c.height - h, 1, h);
    }
}

window.onload = () => new Game();

</script>
</body>
</html>
